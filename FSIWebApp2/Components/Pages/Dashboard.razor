@page "/"
@using System.Text
@using FSIWebApp2.Data
@using FSIWebApp2.Data.Helpers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using FSIWebApp2.Data.Models
@inject IDbContextFactory<FSIWebApp2.Data.ApplicationDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, Owner, Reader")]

<PageTitle>Home</PageTitle>
@* The `overflow-y: auto;` for the scrollbar *@
<div class="container">
    <div class="panel">
        <h3 class="panel-header">What's New</h3>
            <ul>
                <li>Added Protected Towns table.</li>
                <li>User can now download the entire FSI and Protected Towns data sets.</li>
                <li>Dashboard of relevant data items. These items can be changed to show any metric of the database.</li>
                <li>Field mapping from FileMaker to new and renamed fields.</li>
                <li>Functionalty added to improve data quality and user experience, which includes automated fields based on the user's selection</li>
                <li>Addition of Record Type dropdown</li>
                <li>State groups have been rearranged based on previous definitions and nationality. For previous state group labels, the "State Group Override" field can be used.</li>
            </ul>
            <br />
        <h3 class="panel-header">Troubleshooting</h3>
        <ul>
    <li>Required fields are listed in <span style="color: red">RED</span>.</li>
    <li>READ ONLY fields are listed in <span style="color: blue">BLUE</span>.</li>
    <li>Almost all <span style="color: red">REQUIRED </span>fields default to "Unknown" or today's date.</li>
    <li>Search filters remain active unless reset or changed.</li>
    <li>A new protected town CANNOT be created without an existing NFPA FDID.</li>
    <li>Every "State" has been assigned to a state group; However, some "States" have been added to alternate groups based on mailing cycles. The field "State Group Override" has been added to allow specific non-US "states" to maintain their historical mailing groups.</li>
</ul>
    </div>
    

    <div class="panel">
        <h3 class="panel-header">Stats</h3>
        <h2>FSI Records</h2>

        @if (IsLoading)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <div class="card mb-4">
                <div class="card-body">
                    <p class="card-text">Total Records: @_totalFSIRecords</p>
                    <p class="card-text">Updated in the Last Month: @_updatedFSIRecordsInLastMonth</p>
                    <p class="card-text">Created in the Last Month: @_createdFSIRecordsInLastMonth</p>
                    <p class="card-text">ACTIVE records: @_activeRecords</p>
                    <p class="card-text">INACTIVE records: @_inactiveRecords</p>
                    <p class="card-text">UNKNOWN records: @_unknownRecords</p>
                    <p class="card-text">State Group 1: @_stateGroup1</p>
                    <p class="card-text">State Group 2: @_stateGroup2</p>
                    <p class="card-text">State Group 3: @_stateGroup3</p>
                    <p class="card-text">State Group 4: @_stateGroup4</p>
                    <p class="card-text">State with the most records: @(mostRecordsState?.State.GetDisplayName()) (@(mostRecordsState?.Count))</p>
                    <p class="card-text">State with the least records: @(leastRecordsState?.State.GetDisplayName()) (@(leastRecordsState?.Count))</p>
                </div>
            </div>
        }

        <h2>Protected Towns Records</h2>

        @if (IsLoading)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <div class="card mb-4">
                <div class="card-body">
                    <p class="card-text">Total Records: @_totalTownsRecords</p>
                    <p class="card-text">Updated in the Last Month: @_updatedTownsRecordsInLastMonth</p>
                    <p class="card-text">Created in the Last Month: @_createdTownsRecordsInLastMonth</p>
                </div>
            </div>
        }
    </div>

    <div class="panel">
        <h3 class="panel-header">Downloads</h3>


        <p>Select a table to download as a .csv file:</p>
        <AuthorizeView Roles="Admin, Owner, Reader">
            <div class="form-dropdown mb-3">
                <select class="form-select" @bind="SelectedTable">
                    <option value="FSI">FSI</option>
                    <option value="ProtectedTowns">Protected Towns</option>
                </select>
            </div>
        </AuthorizeView>
        @if (IsLoading)
        {
            <p><em>Loading...</em></p>
        }
        else if (IsError)
        {
            <div class="alert alert-danger" role="alert">
                @Message
            </div>
        }
        else
        {
            <button class="btn btn-primary" @onclick="DownloadCsv">Download</button>
        }
        
    </div>
</div>

@code {
    private List<FSI> fsis = new();
    private List<ProtectedTowns> protectedtowns = new();
    private bool IsLoading { get; set; } = true;
    private bool IsError { get; set; } = false;
    private string Message { get; set; } = string.Empty;
    private string SelectedTable { get; set; } = "FSI"; // Default value
    private int _totalFSIRecords;
    private int _totalTownsRecords;
    private int _updatedFSIRecordsInLastMonth;
    private int _updatedTownsRecordsInLastMonth;
    private int _createdFSIRecordsInLastMonth;
    private int _createdTownsRecordsInLastMonth;
    private int _activeRecords;
    private int _inactiveRecords;
    private int _unknownRecords;
    private int _stateGroup1;
    private int _stateGroup2;
    private int _stateGroup3;
    private int _stateGroup4;

    private StateRecordCount? mostRecordsState;
    private StateRecordCount? leastRecordsState;

    public class StateRecordCount
    {
        public EnumList.StateList State { get; set; }
        public int Count { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        IsError = false;

        try
        {
            // Use the factory to create a database context
            await using var context = await DbFactory.CreateDbContextAsync();

            // Get the total count of all records
            _totalFSIRecords = await context.FSI.CountAsync();
            _totalTownsRecords = await context.ProtectedTowns.CountAsync();

            // Get the count of records updated in the last month
            var updatedOneMonthAgo = DateTime.Now.AddMonths(-1);
            _updatedFSIRecordsInLastMonth = await context.FSI
                .CountAsync(f => f.UpdatedDt >= updatedOneMonthAgo);
            _updatedTownsRecordsInLastMonth = await context.ProtectedTowns
                .CountAsync(f => f.UpdatedDt >= updatedOneMonthAgo);

            // Get the count of records created in the last month
            var createdOneMonthAgo = DateTime.Now.AddMonths(-1);
            _createdFSIRecordsInLastMonth = await context.FSI
                .CountAsync(f => f.CreatedDt >= createdOneMonthAgo);
            _createdTownsRecordsInLastMonth = await context.ProtectedTowns
                .CountAsync(f => f.CreatedDt >= createdOneMonthAgo);

            // Get the count of records with a "Active" RecordStatus
            _activeRecords = await context.FSI.CountAsync(f => f.RecordStatus == Data.Models.EnumList.Status.Active);

            // Get the count of records with a "Inactive" RecordStatus
            _inactiveRecords = await context.FSI.CountAsync(f => f.RecordStatus == Data.Models.EnumList.Status.Inactive);

            // Get the count of records with a "Unknown" RecordStatus
            _unknownRecords = await context.FSI.CountAsync(f => f.RecordStatus == Data.Models.EnumList.Status.Unknown);

            // Get the count of records in State Group 1
            _stateGroup1 = await context.FSI.CountAsync(f => f.StateGroup == 1);

            // Get the count of records in State Group 2
            _stateGroup2 = await context.FSI.CountAsync(f => f.StateGroup == 2);

            // Get the count of records in State Group 3
            _stateGroup3 = await context.FSI.CountAsync(f => f.StateGroup == 3);

            // Get the count of records in State Group 4
            _stateGroup4 = await context.FSI.CountAsync(f => f.StateGroup == 4);

            // Get Most and Least by State
            var recordsByState = await context.FSI
                .GroupBy(f => f.State)
                .Select(g => new StateRecordCount
                {
                    State = g.Key,
                    Count = g.Count()
                })
                .ToListAsync();

            mostRecordsState = recordsByState.OrderByDescending(r => r.Count).FirstOrDefault();
            leastRecordsState = recordsByState.OrderBy(r => r.Count).FirstOrDefault();

            fsis = await context.FSI.ToListAsync();
            protectedtowns = await context.ProtectedTowns.ToListAsync();
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = $"An error occurred while loading data: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DownloadCsv()
    {
        IsLoading = true;
        IsError = false;
        Message = string.Empty;

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            string csvContent = string.Empty;
            string filename = string.Empty;

            // Added the option to select which table to download
            switch (SelectedTable)
            {
                case "FSI":
                    csvContent = await GenerateFsiCsvAsync(context);
                    filename = "FSI_Data.csv";
                    break;
                case "ProtectedTowns":
                    csvContent = await GenerateProtectedTownsCsvAsync(context);
                    filename = "ProtectedTowns_Data.csv";
                    break;
                default:
                    Message = "Please select valid table.";
                    IsLoading = false;
                    return;
            }

            if (string.IsNullOrEmpty(csvContent))
            {
                IsLoading = false;
                return;
            }

            // Call the BlazorHelper.js 
            await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", filename, csvContent);
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = $"An error occurred during download: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task<string> GenerateFsiCsvAsync(ApplicationDbContext context)
    {
        var fsisToDownload = await context.FSI.AsNoTracking().ToListAsync();
        if (!fsisToDownload.Any())
        {
            Message = "No FSI records found to download.";
            return string.Empty;
        }

        // Customize Download ***************** Consider custom options for user *******************
        var sb = new StringBuilder();
        sb.AppendLine("NfpaFdid,NfirsId,FdName,CreatedDt,UpdatedDt,Street,Street2,City,CountyNo,State,StateId,StateGroup,StateGroupOverride,Zipcode,Zipcode2,Region,Country,AddressDt,Phone,PhoneDt,Email,EmailDt,Fax,FaxDt,ContactName,ContactRank,ContactRankId,ContactDt,RecordType,RecordTypeId,RecordStatus,CrossRefId,SmSa,DataSource,SquareMiles,Community,CommunityId,Population,PopInterval,PopIntervalId,TypeEmps,TypeEmpsId,PaidEmps,PaidEmpsWomen,WorkWeek,EmpsPerShift,VolsComp,Vols,VolsWomen,Pumpers,Ladders,Combo,MarineVessels,OtherSupport,OtherVehicles,ThermalEquipment,Stations,Ems,EmsId,Ambulance,Dispatch,DispatchId,Training,TrainingId,CodeEnforcement,CodeEnforcementId,LastReturned,LastSent,Notes,FdSurveyStatus1,FdSurveyStatus2,FdSurveyStatus3,FdSurveyStatus4,FdSurveyStatus5,FdSurveyStatus6,FdSurveyStatus7,FdSurveyYears1,FdSurveyYears2,FdSurveyYears3,FdSurveyYears4,FdSurveyYears5,FdSurveyYears6,FdSurveyYears7"); /* LastReturned,LastSent, */
        foreach (var fsi in fsisToDownload)
        {
            sb.AppendLine($"{fsi.NfpaFdid},{fsi.NfirsId},{fsi.FdName},{fsi.CreatedDt},{fsi.UpdatedDt},{fsi.Street},{fsi.Street2},{fsi.City},{fsi.CountyNo},{fsi.State},{fsi.StateId},{fsi.StateGroup},{fsi.StateGroupOverride},{fsi.Zipcode},{fsi.Zipcode2},{fsi.Region},{fsi.Country},{fsi.AddressDt},{fsi.Phone},{fsi.PhoneDt},{fsi.Email},{fsi.EmailDt},{fsi.Fax},{fsi.FaxDt},{fsi.ContactName},{fsi.ContactRank},{fsi.ContactRankId},{fsi.ContactDt},{fsi.RecordType},{fsi.RecordTypeId},{fsi.RecordStatus},{fsi.CrossRefId},{fsi.SmSa},{fsi.DataSource},{fsi.SquareMiles},{fsi.Community},{fsi.CommunityId},{fsi.Population},{fsi.PopInterval},{fsi.PopIntervalId},{fsi.TypeEmps},{fsi.TypeEmpsId},{fsi.PaidEmps},{fsi.PaidEmpsWomen},{fsi.WorkWeek},{fsi.EmpsPerShift},{fsi.VolsComp},{fsi.Vols},{fsi.VolsWomen},{fsi.Pumpers},{fsi.Ladders},{fsi.Combo},{fsi.MarineVessels},{fsi.OtherSupport},{fsi.OtherVehicles},{fsi.ThermalEquipment},{fsi.Stations},{fsi.Ems},{fsi.EmsId},{fsi.Ambulance},{fsi.Dispatch},{fsi.DispatchId},{fsi.Training},{fsi.TrainingId},{fsi.CodeEnforcement},{fsi.CodeEnforcementId},{fsi.LastReturned},{fsi.LastSent},{fsi.Notes},{fsi.FdSurveyStatus1},{fsi.FdSurveyStatus2},{fsi.FdSurveyStatus3},{fsi.FdSurveyStatus4},{fsi.FdSurveyStatus5},{fsi.FdSurveyStatus6},{fsi.FdSurveyStatus7},{fsi.FdSurveyYears1},{fsi.FdSurveyYears2},{fsi.FdSurveyYears3},{fsi.FdSurveyYears4},{fsi.FdSurveyYears5},{fsi.FdSurveyYears6},{fsi.FdSurveyYears7}");
        }
        return sb.ToString();
    }

    private async Task<string> GenerateProtectedTownsCsvAsync(ApplicationDbContext context)
    {
        var protectedTowns = await context.ProtectedTowns.AsNoTracking().ToListAsync();
        if (!protectedTowns.Any())
        {
            Message = "No Protected Towns records found to download.";
            return string.Empty;
        }

        // Customize Download
        var sb = new StringBuilder();
        sb.AppendLine("TownProtectedId,TownProtectedName,NfpaFdid,FdName,City,State,StateId,StateGroup,StateGroupOverride,CreatedDt,UpdatedDt");
        foreach (var town in protectedTowns)
        {
            sb.AppendLine($"{town.TownProtectedId},{town.TownProtectedName},{town.NfpaFdid},{town.FdName},{town.City},{town.State},{town.StateId},{town.StateGroup},{town.StateGroupOverride},{town.CreatedDt},{town.UpdatedDt}");
        }
        return sb.ToString();
    }
}

@* ********** ONLY FSI DOWNLOAD **********

 private async Task DownloadCsv()
    {

        // null check
        if (fsis == null || !fsis.Any())
        {
            IsError = true;
            Message = "No data to download.";
            return;
        }

        var csvContent = GenerateCsvContent(fsis);
        await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", "fsi-data.csv", csvContent);
    }

    private string GenerateCsvContent(List<FSI> data)
    {
        var sb = new StringBuilder();
        // Adding custom header row
        sb.AppendLine("NfpaFdid, NfirsId, FdName, CreatedDt, UpdatedDt, Street, Street2, City, CountyNo, State, StateId, StateGroup, Zipcode, Zipcode2, Region, Country, AddressDt, Phone, PhoneDt, Email, EmailDt, Fax, FaxDt, ContactName, ContactRank, ContactRankId, ContactDt, RecordType, RecordTypeId, RecordStatus, CrossRefId, SmSa, DataSource, SquareMiles, Community, CommunityId, Population, PopInterval, PopIntervalId, TypeEmps, TypeEmpsId, PaidEmps, PaidEmpsWomen, WorkWeek, EmpsPerShift, VolsComp, Vols, VolsWomen, Pumpers, Ladders, Combo, MarineVessels, OtherSupport, OtherVehicles, ThermalEquipment, Stations, Ems, EmsId, Ambulance, Dispatch, DispatchId, Training, TrainingId, CodeEnforcement, CodeEnforcementId, LastReturned, LastSent, Notes, FdSurveyStatus1, FdSurveyStatus2, FdSurveyStatus3, FdSurveyStatus4, FdSurveyStatus5, FdSurveyStatus6, FdSurveyStatus7, FdSurveyYears1, FdSurveyYears2, FdSurveyYears3, FdSurveyYears4, FdSurveyYears5, FdSurveyYears6, FdSurveyYears7");

        // Adding custom data rows
        foreach (var fsi in data)
        {
            sb.AppendLine($"{fsi.NfpaFdid},{fsi.NfirsId},{fsi.FdName},{fsi.CreatedDt},{fsi.UpdatedDt},{fsi.Street},{fsi.Street2},{fsi.City},{fsi.CountyNo},{fsi.State},{fsi.StateId},{fsi.StateGroup},{fsi.Zipcode},{fsi.Zipcode2},{fsi.Region},{fsi.Country},{fsi.AddressDt},{fsi.Phone},{fsi.PhoneDt},{fsi.Email},{fsi.EmailDt},{fsi.Fax},{fsi.FaxDt},{fsi.ContactName},{fsi.ContactRank},{fsi.ContactRankId},{fsi.ContactDt},{fsi.RecordType},{fsi.RecordTypeId},{fsi.RecordStatus},{fsi.CrossRefId},{fsi.SmSa},{fsi.DataSource},{fsi.SquareMiles},{fsi.Community},{fsi.CommunityId},{fsi.Population},{fsi.PopInterval},{fsi.PopIntervalId},{fsi.TypeEmps},{fsi.TypeEmpsId},{fsi.PaidEmps},{fsi.PaidEmpsWomen},{fsi.WorkWeek},{fsi.EmpsPerShift},{fsi.VolsComp},{fsi.Vols},{fsi.VolsWomen},{fsi.Pumpers},{fsi.Ladders},{fsi.Combo},{fsi.MarineVessels},{fsi.OtherSupport},{fsi.OtherVehicles},{fsi.ThermalEquipment},{fsi.Stations},{fsi.Ems},{fsi.EmsId},{fsi.Ambulance},{fsi.Dispatch},{fsi.DispatchId},{fsi.Training},{fsi.TrainingId},{fsi.CodeEnforcement},{fsi.CodeEnforcementId},{fsi.LastReturned},{fsi.LastSent},{fsi.Notes},{fsi.FdSurveyStatus1},{fsi.FdSurveyStatus2},{fsi.FdSurveyStatus3},{fsi.FdSurveyStatus4},{fsi.FdSurveyStatus5},{fsi.FdSurveyStatus6},{fsi.FdSurveyStatus7},{fsi.FdSurveyYears1},{fsi.FdSurveyYears2},{fsi.FdSurveyYears3},{fsi.FdSurveyYears4},{fsi.FdSurveyYears5},{fsi.FdSurveyYears6},{fsi.FdSurveyYears7}");
        }

        return sb.ToString();
    } *@


